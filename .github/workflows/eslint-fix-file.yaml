name: ESLint Fix File

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "repository"
        required: true
        type: string

      branch:
        description: "branch"
        required: true
        type: string

      relative_file_path:
        description: "relative file path"
        required: true
        type: string

      eslint_rule:
        description: "eslint rule (example: quotes)"
        required: true
        type: string

      node_version:
        description: "node version"
        default: "20.19.4"
        required: true
        type: string

      create_pr:
        description: "create pull request"
        type: boolean
        default: false

      upstream:
        description: "upstream repository"
        required: false
        type: string

      upstream_pr:
        description: "create upstream pull request"
        type: boolean
        default: false

jobs:
  eslint-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.branch }}
          token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run ESLint with --fix-dry-run
        run: |
          NODE_OPTIONS="--max-old-space-size=16384" \
          npx eslint \
          "${{ inputs.relative_file_path }}" \
          --fix-dry-run \
          --format stylish \
          --color \
          --rule '${{ inputs.eslint_rule }}: error' \

      - name: Run ESLint with --fix
        run: |
          NODE_OPTIONS="--max-old-space-size=16384" \
          npx eslint \
          "${{ inputs.relative_file_path }}" \
          --fix \
          --rule '${{ inputs.eslint_rule }}: error' \

      - name: Run prettier --write
        run: |
          if ! git diff --quiet; then
            npx prettier --write ${{ inputs.relative_file_path }}
          fi

      - name: Setup Git user
        run: |
          git config user.name "gelocraft"
          git config user.email "gelocraft@users.noreply.github.com"
          git config user.signingkey ~/.ssh/signingkey.pub

          git config tag.gpgsign true
          git config commit.gpgsign true
          git config gpg.format ssh
          git config gpg.ssh.allowedSignersFile ~/.ssh/allowedsigners

          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_SIGNING_KEY }}" > ~/.ssh/signingkey
          chmod 600 ~/.ssh/signingkey

          echo "${{ secrets.SSH_SIGNING_KEY_PUB }}" > ~/.ssh/signingkey.pub
          chmod 600 ~/.ssh/signingkey.pub

          echo "${{ secrets.SSH_ALLOWED_SIGNERS }}" > ~/.ssh/allowedsigners
          chmod 600 ~/.ssh/allowedsigners

      - name: Commit changes (if any)
        run: |
          git add .
          git status -s
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 1
          fi
          git commit -m "fix(eslint): auto-fix ${{ inputs.eslint_rule }} rule violations"

      - name: Push changes to new branch
        if: ${{ inputs.create_pr == true }}
        id: push
        run: |
          BRANCH_NAME="eslint-fix/${{ inputs.eslint_rule }}-$(date +%s)"
          git push origin HEAD:$BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create PR origin branch
        if: ${{ inputs.create_pr == true && inputs.upstream_pr == false }}
        run: |
          gh pr create \
            --repo "${{ inputs.repository }}" \
            --title "fix(eslint): auto-fix ${{ inputs.eslint_rule }} rule violations" \
            --body "Automatically fixed ESLint ${{ inputs.eslint_rule }} rule violations." \
            --base "${{ inputs.branch }}" \
            --head "$BRANCH_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}

      - name: Create PR upstream branch
        if: ${{ inputs.create_pr == true && inputs.upstream_pr == true }}
        run: |
          gh pr create \
            --repo "${{ inputs.upstream }}" \
            --title "fix(eslint): auto-fix ${{ inputs.eslint_rule }} rule violations" \
            --body "Automatically fixed ESLint ${{ inputs.eslint_rule }} rule violations." \
            --base "main" \
            --head "$BRANCH_NAME"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
